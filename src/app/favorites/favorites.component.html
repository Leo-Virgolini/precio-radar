<div class="max-w-6xl mx-auto px-4 pt-4">
  <p-breadcrumb [model]="breadcrumbItems" [home]="homeItem" />
</div>

<section class="bg-primary p-3">
  <!-- Header -->
  <div class="flex flex-column md:flex-row justify-content-between align-items-center mb-4 gap-3">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold m-0 mb-2">
        <i class="pi pi-heart-fill text-3xl mr-2" style="color: #ef4444;"></i>Mis Productos Guardados
      </h1>
      <p class="text-base font-normal text-blue-100 m-0">
        @if (products().length > 0) {
          {{ products().length }} producto{{ products().length > 1 ? 's' : '' }} guardado{{ products().length > 1 ? 's' : '' }}
        } @else if (!isLoading()) {
          No tenés productos guardados todavía
        }
      </p>
    </div>
    <div class="flex align-items-center gap-2">
      @if (products().length > 0) {
        <p-button label="Limpiar todo" icon="pi pi-trash" severity="danger" size="small" (onClick)="confirmClearAll()" />
      }
      <p-button label="Volver a buscar" icon="pi pi-arrow-left" size="small" routerLink="/" severity="secondary" />
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="grid">
      @for (item of [1,2,3,4]; track item) {
        <div class="col-12 sm:col-6 lg:col-4 xl:col-3 p-2">
          <div class="bg-white-alpha-10 border-round-xl p-3">
            <p-skeleton width="100%" height="14rem" class="mb-3" />
            <p-skeleton width="60%" height="1rem" class="mb-2" />
            <p-skeleton width="100%" height="1rem" class="mb-2" />
            <p-skeleton width="80%" height="1rem" class="mb-3" />
            <p-skeleton width="40%" height="1.5rem" class="mb-2" />
            <p-skeleton width="50%" height="1rem" />
          </div>
        </div>
      }
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && products().length === 0) {
    <div class="flex flex-column align-items-center justify-content-center py-8 px-4 bg-white-alpha-10 border-round-xl animate-fade-in">
      <i class="pi pi-heart text-6xl mb-4 text-blue-200"></i>
      <h3 class="text-xl font-semibold m-0 mb-2 text-white">No tenés productos guardados</h3>
      <p class="text-sm m-0 mb-4 text-center text-blue-100" style="max-width: 24rem;">
        Explorá productos y tocá el corazón para guardarlos. Así podés volver a verlos cuando quieras.
      </p>
      <p-button label="Explorar productos" icon="pi pi-search" severity="warn" routerLink="/" />
    </div>
  }

  <!-- Products Grid -->
  @if (!isLoading() && products().length > 0) {
    <div class="bg-white-alpha-10 border-round-xl p-4 border-white-alpha-20">
      <div class="grid">
        @for (product of products(); track product.asin) {
          <div class="col-12 sm:col-6 lg:col-4 xl:col-3 p-2 animate-card-enter"
            [class.animate-card-leave]="removingAsins().has(product.asin)"
            [style.animation-delay]="removingAsins().has(product.asin) ? '0ms' : ($index * 50) + 'ms'">
            <p-card class="h-full border-round-xl overflow-hidden cursor-pointer" (click)="openProductDetail(product)">
              <ng-template #header>
                <div class="relative product-card-image">
                  <div class="product-detail-overlay">
                    <span><i class="pi pi-eye"></i>Ver detalles</span>
                  </div>
                  <div class="flex align-items-center justify-content-center product-image-bg" style="height: 14rem;">
                    <img [src]="resizeImageUrl(product.imageUrls[0], 'card')" [alt]="product.title" style="max-width: 90%; max-height: 90%; object-fit: contain;"
                      (error)="onImageError($event)" />
                  </div>
                  <div class="absolute top-0 left-0 m-2" style="z-index: 1;">
                    <p-button icon="pi pi-trash" [rounded]="true" severity="danger" size="small"
                      aria-label="Quitar de favoritos" (onClick)="removeFavorite(product); $event.stopPropagation()" />
                  </div>
                  @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
                    <span class="discount-badge discount-badge-lg">
                      -{{ getDiscountPercentage(product.originalPrice, product.currentPrice ?? 0) }}%
                    </span>
                  }
                  @if (!product.inStock) {
                    <div class="out-of-stock-overlay">
                      <span class="out-of-stock-badge">Sin stock</span>
                    </div>
                  }
                </div>
              </ng-template>

              <ng-template #content>
                <div class="flex flex-column" style="min-height: 14rem;">
                  <!-- Category and Region -->
                  <div class="mb-2 flex align-items-center gap-2 flex-wrap">
                    <p-tag [value]="product.category" icon="pi pi-tag" severity="info" />
                    <span class="inline-flex align-items-center gap-1 px-2 py-1 border-round text-xs font-semibold"
                      [class]="product.region === 'ES' ? 'bg-orange-100 text-orange-900' : 'bg-blue-100 text-blue-900'">
                      <img [src]="product.region === 'ES' ? 'https://flagcdn.com/16x12/es.png' : 'https://flagcdn.com/16x12/us.png'"
                        width="16" height="12" [alt]="product.region === 'ES' ? 'España' : 'USA'" />
                      {{ getRegionLabel(product) }}
                    </span>
                  </div>

                  <!-- Product Title -->
                  <h4 class="product-title text-base font-semibold m-0 line-height-3 text-body">
                    {{ product.title }}
                  </h4>

                  <!-- Rating -->
                  @if (product.rating > 0) {
                    <div class="flex align-items-center gap-2 mt-1">
                      <p-rating [ngModel]="product.rating" [readonly]="true" [stars]="5" />
                      <span class="text-xs font-semibold text-body">{{ product.rating }}</span>
                      <span class="text-xs text-muted">({{ product.ratingCount.toLocaleString() }})</span>
                    </div>
                  }

                  <!-- Features -->
                  @if (product.aboutItem.length) {
                    <ul class="text-sm m-0 mt-1 pl-3 line-height-3 text-muted list-none" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                      @for (feature of product.aboutItem; track feature) {
                      <li class="mb-1">{{ feature }}</li>
                      }
                    </ul>
                  }

                  <!-- Price block pushed to bottom -->
                  <div class="flex flex-column gap-2 mt-auto">
                    <p-divider />
                    <!-- Current price -->
                    <div class="flex align-items-baseline gap-2 flex-wrap">
                      <span class="text-2xl font-bold price-green">
                        {{ getCurrencySymbol(product) }}{{ formatPrice(product.currentPrice) }}
                      </span>
                      <span class="text-xs text-muted">{{ getCurrencyCode(product) }}</span>
                      @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
                        <span class="text-sm line-through text-muted">
                          {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice) }}
                        </span>
                        <span class="text-xs font-semibold savings-highlight">
                          <i class="pi pi-bolt text-xs mr-1"></i>Ahorrás {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice - (product.currentPrice ?? 0)) }}
                        </span>
                      }
                    </div>

                    <!-- Shipping -->
                    <div class="flex flex-column gap-1 text-sm">
                      @if (isDigitalProduct(product)) {
                        <div class="flex align-items-center gap-2">
                          <i class="pi pi-download text-xs price-green"></i>
                          <span class="price-green font-medium">Descarga digital</span>
                        </div>
                      } @else if (isFreeShipping(product)) {
                        <div class="flex align-items-center gap-2">
                          <i class="pi pi-truck text-xs price-green"></i>
                          <span class="price-green font-medium">Envío gratis a Argentina</span>
                        </div>
                      } @else {
                        <div class="flex align-items-center gap-2">
                          <i class="pi pi-truck text-xs shipping-info"></i>
                          <span class="shipping-info">Envío: {{ getCurrencySymbol(product) }}{{ formatPrice(getShippingPrice(product)) }}</span>
                        </div>
                        @if (product.freeShippingOver99) {
                          <div class="flex align-items-center gap-1">
                            <i class="pi pi-info-circle text-xs price-green"></i>
                            <span class="price-green text-xs">Envío gratis en pedidos $99+</span>
                          </div>
                        }
                      }
                    </div>

                    <!-- CTA Buttons -->
                    <div class="flex flex-column gap-2">
                      <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn"
                        styleClass="w-full" (onClick)="openAmazonProduct(product.url); $event.stopPropagation()" />
                      <p-button label="Agregar al carrito" icon="pi pi-shopping-cart" [outlined]="true" severity="warn"
                        styleClass="w-full" (onClick)="openAmazonProduct(product.addToCartUrl); $event.stopPropagation()" />
                    </div>
                  </div>
                </div>
              </ng-template>
            </p-card>
          </div>
        }
      </div>
    </div>

    <!-- Info note -->
    <div class="mt-3 text-center">
      <p class="text-xs text-blue-200 m-0">
        <i class="pi pi-info-circle mr-1"></i>Los precios y disponibilidad se actualizan cada vez que visitás esta página.
      </p>
    </div>
  }
</section>

<p-confirmDialog />

<!-- Product Detail Dialog -->
@if (selectedProduct(); as product) {
  <p-dialog [visible]="showProductDialog()" (visibleChange)="onDialogVisibilityChange($event)" [modal]="true" [dismissableMask]="true" [draggable]="false"
    [style]="{ width: '90vw', 'max-width': '50rem' }" [breakpoints]="{ '768px': '95vw' }">
    <ng-template #header>
      <div class="flex align-items-center gap-2">
        <p-tag [value]="product.category" icon="pi pi-tag" severity="info" />
        <span class="inline-flex align-items-center gap-1 px-2 py-1 border-round text-xs font-semibold"
          [class]="product.region === 'ES' ? 'bg-orange-100 text-orange-900' : 'bg-blue-100 text-blue-900'">
          <img [src]="product.region === 'ES' ? 'https://flagcdn.com/16x12/es.png' : 'https://flagcdn.com/16x12/us.png'"
            width="16" height="12" [alt]="product.region === 'ES' ? 'España' : 'USA'" />
          {{ getRegionLabel(product) }}
        </span>
        @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
          <span class="discount-badge discount-badge-sm">
            -{{ getDiscountPercentage(product.originalPrice, product.currentPrice ?? 0) }}%
          </span>
        }
        <p-button icon="pi pi-trash" [rounded]="true" severity="danger" size="small"
          aria-label="Quitar de favoritos" (onClick)="removeFavorite(product); showProductDialog.set(false)" />
      </div>
    </ng-template>

    <div class="flex flex-column md:flex-row gap-3 md:gap-4">
      <!-- Left column: Image + Price + Button -->
      <div class="flex-shrink-0 md:w-20rem flex flex-column gap-3">
        <p-galleria [value]="getProductImages(product, 'detail')" [numVisible]="4" [showThumbnails]="getProductImages(product).length > 1"
          [showIndicators]="false" [showItemNavigators]="getProductImages(product).length > 1"
          [showItemNavigatorsOnHover]="false" [responsiveOptions]="galleriaResponsiveOptions"
          [activeIndex]="activeImageIndex()" (activeIndexChange)="activeImageIndex.set($event)"
          [containerStyle]="{ 'max-width': '100%' }">
          <ng-template #item let-item>
            <div class="flex align-items-center justify-content-center product-image-bg border-round p-3" style="min-height: 18rem;">
              <p-image [src]="resizeImageUrl(item, 'full')" [alt]="product.title" imageClass="fav-dialog-image" [preview]="true" (onImageError)="onImageError($event)" />
            </div>
          </ng-template>
          <ng-template #thumbnail let-item>
            <div class="flex align-items-center justify-content-center border-1 border-round surface-border surface-ground p-1" style="width: 4rem; height: 4rem;">
              <img [src]="resizeImageUrl(item, 'thumbnail')" [alt]="product.title" style="max-width: 100%; max-height: 100%; object-fit: contain;"
                (error)="onImageError($event)" />
            </div>
          </ng-template>
        </p-galleria>

        <!-- Buy Box -->
        <div class="buy-box surface-ground border-1 surface-border border-round-lg p-3 flex flex-column gap-2">
          <!-- Price -->
          <div class="flex align-items-baseline gap-2 flex-wrap">
            <span class="text-2xl font-bold price-green">
              {{ getCurrencySymbol(product) }}{{ formatPrice(product.currentPrice) }}
            </span>
            <span class="text-xs text-muted">{{ getCurrencyCode(product) }}</span>
          </div>
          @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
          <div class="flex align-items-center gap-2 flex-wrap">
            <span class="text-sm line-through text-muted">
              {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice) }}
            </span>
            <span class="text-xs font-semibold savings-highlight">
              <i class="pi pi-bolt text-xs mr-1"></i>Ahorrás {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice - (product.currentPrice ?? 0)) }}
            </span>
          </div>
          }

          <p-divider class="my-0" />

          <!-- Shipping -->
          @if (isDigitalProduct(product)) {
          <div class="flex align-items-center gap-2">
            <i class="pi pi-download price-green text-sm"></i>
            <span class="price-green font-medium text-sm">Descarga digital</span>
          </div>
          } @else if (isFreeShipping(product)) {
          <div class="flex align-items-center gap-2">
            <i class="pi pi-truck price-green text-sm"></i>
            <span class="price-green font-medium text-sm">Envío gratis a Argentina</span>
          </div>
          } @else {
          <div class="flex align-items-center gap-2">
            <i class="pi pi-truck shipping-info text-sm"></i>
            <span class="shipping-info text-sm">
              Envío: {{ getCurrencySymbol(product) }}{{ formatPrice(getShippingPrice(product)) }} {{ getCurrencyCode(product) }}
            </span>
          </div>
          @if (product.freeShippingOver99) {
          <div class="flex align-items-center gap-1">
            <i class="pi pi-info-circle text-xs price-green"></i>
            <span class="price-green text-xs">Envío gratis en pedidos $99+</span>
          </div>
          }
          }

          <!-- Import Charges -->
          @if ((product.importCharges ?? 0) > 0) {
          <div class="flex align-items-center gap-2">
            <i class="pi pi-globe shipping-info text-sm"></i>
            <span class="shipping-info text-sm">
              Importación: {{ getCurrencySymbol(product) }}{{ formatPrice(product.importCharges) }} {{ getCurrencyCode(product) }}
            </span>
          </div>
          }

          <p-divider class="my-0" />

          <!-- Availability + Destination -->
          <div class="flex align-items-center gap-2">
            <i [class]="'pi text-sm ' + (product.inStock ? 'pi-check-circle price-green' : 'pi-times-circle text-red-500')"></i>
            <span [class]="'text-sm ' + (product.inStock ? 'text-body' : 'text-red-500 font-semibold')">{{ product.inStock ? 'En stock' : 'Sin stock' }}</span>
          </div>
          <div class="flex align-items-center gap-2">
            <i class="pi pi-map-marker text-muted text-sm"></i>
            <span class="text-sm text-muted">Envío a: Argentina</span>
          </div>

          <!-- CTA Buttons -->
          <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn" styleClass="w-full" (onClick)="openAmazonProduct(product.url)" />
          <p-button label="Agregar al carrito" icon="pi pi-shopping-cart" [outlined]="true" severity="warn" styleClass="w-full" (onClick)="openAmazonProduct(product.addToCartUrl)" />
          <p class="text-xs m-0 text-muted text-center">
            <i class="pi pi-info-circle mr-1"></i>Precios sujetos a cambios.
          </p>
        </div>
      </div>

      <!-- Right column: Title + Rating + Features -->
      <div class="flex-1 flex flex-column gap-3">
        <h3 class="text-sm md:text-base font-bold m-0 line-height-3 text-body">
          {{ product.title }}
        </h3>

        @if (product.rating > 0) {
        <div class="flex align-items-center gap-2">
          <p-rating [ngModel]="product.rating" [readonly]="true" [stars]="5" />
          <span class="text-sm font-semibold text-body">{{ product.rating }}</span>
          <span class="text-sm text-muted">({{ product.ratingCount.toLocaleString() }} reseñas)</span>
        </div>
        }

        @if (product.aboutItem.length) {
        <div #dialogFeatures class="overflow-hidden" [style.max-height]="showAllFeatures() ? 'none' : '24rem'">
          <ul class="text-sm m-0 pl-0 line-height-3 text-muted list-none">
            @for (feature of product.aboutItem; track feature) {
            <li class="mb-2 flex align-items-start gap-2">
              <i class="pi pi-check-circle text-xs mt-1 price-green"></i>
              <span>{{ feature }}</span>
            </li>
            }
          </ul>
        </div>
        @if (featuresOverflow() || showAllFeatures()) {
        <a class="text-xs cursor-pointer text-primary font-medium" (click)="showAllFeatures.set(!showAllFeatures())">
          <i class="pi" [class]="showAllFeatures() ? 'pi-chevron-up' : 'pi-chevron-down'" style="font-size: 0.65rem;"></i>
          {{ showAllFeatures() ? 'Ver menos' : 'Ver más' }}
        </a>
        }
        }
      </div>
    </div>

  </p-dialog>
}
