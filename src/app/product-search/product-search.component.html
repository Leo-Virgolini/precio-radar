<div class="bg-primary p-3">
  <!-- Quick Actions -->
  <div class="bg-white-alpha-10 backdrop-blur-md border-round p-4 border-white-alpha-20">
    <div class="flex flex-wrap gap-2 justify-content-center">
      @for (action of quickActions; track action.action) {
        <p-button [label]="action.label" [icon]="action.icon" severity="secondary" size="small" (onClick)="onQuickAction(action)" class="mb-2" />
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="bg-white-alpha-5 backdrop-blur-md border-round p-6 border-white-alpha-10">
      <div class="text-center mb-4">
        <p-progressSpinner />
        <p class="mt-3 text-white">Buscando productos...</p>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage()) {
    <div class="mb-4">
      <p-message severity="error" [text]="errorMessage()" />
    </div>
  }

  <!-- Results -->
  @if (searchResults() && !isLoading()) {
    <div class="bg-white-alpha-5 backdrop-blur-md border-round border-white-alpha-10">
      <!-- DataView Controls -->
      <form [formGroup]="filterForm">
        <div class="flex flex-column md:flex-row justify-content-between align-items-center gap-3">
          <div class="flex align-items-center gap-3">
            <h2 class="text-xl md:text-2xl font-semibold text-white">
              @if (searchQuery) {
                Resultados de búsqueda de "{{ searchQuery }}"
              } @else {
                Resultados de búsqueda
              }
            </h2>
            <span class="text-sm md:text-base font-normal text-blue-100">
              ({{ searchResults()?.totalResults || 0 }} productos encontrados)
            </span>
          </div>
          <!-- Sort Options -->
          <div class="flex align-items-center gap-3">
            <label for="sortOptions" class="text-white font-medium block">Ordenar por:</label>
            <p-select [options]="sortOptions" formControlName="selectedSort" optionLabel="label" optionValue="value" (onChange)="onSortChange($event.value)" placeholder="Ordenar por"
              class="w-12rem">
              <ng-template #item let-option>
                <div class="flex align-items-center gap-2">
                  <i [class]="option.icon"></i>
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>
        </div>
      </form>

      <div class="grid">
        <!-- Filters Sidebar -->
        <div class="col-12 md:col-2">
          <form [formGroup]="filterForm" class="bg-white-alpha-10 backdrop-blur-md border-round p-4 border-white-alpha-20">
            <h4 class="text-white font-semibold mt-0">Filtros</h4>

            <!-- Max Price Filter -->
            <div class="mb-4">
              <label class="text-white font-medium mb-2 block">Precio Máximo</label>
              <p-slider formControlName="maxPrice" [min]="0" [max]="10000" (onChange)="applyFilters()" class="w-full">
              </p-slider>
              <div class="text-center text-white text-sm mt-2">
                <span>{{ getCurrencySymbol() }}{{ filterForm.get('maxPrice')?.value || 0 }} {{ getCurrencyCode() }}</span>
              </div>
            </div>

            <!-- Category Filter -->
            <div class="mb-4">
              <label class="text-white font-medium mb-2 block">Categoría</label>
              <p-select [options]="categories" formControlName="selectedCategory" optionLabel="label" optionValue="value" placeholder="Todas las categorías" (onChange)="applyFilters()" class="w-full">
                <ng-template #item let-option>
                  <div class="flex align-items-center gap-2">
                    <i [class]="option.icon"></i>
                    <span>{{ option.label }}</span>
                  </div>
                </ng-template>
              </p-select>
            </div>

            <!-- Free Shipping Filter -->
            <div class="mb-4">
              <label class="text-white font-medium mb-2 block">Envío</label>
              <div class="flex align-items-center gap-2">
                <p-checkbox formControlName="freeShippingOnly" [binary]="true" inputId="freeShipping" (onChange)="applyFilters()" />
                <label for="freeShipping" class="text-sm text-white">Solo envío gratis ({{ getFreeShippingThreshold() }})</label>
              </div>
            </div>

            <!-- Clear Filters -->
            <p-button label="Limpiar" icon="pi pi-filter-slash" severity="secondary" size="small" class="w-full" (onClick)="clearFilters()" />
          </form>
        </div>

        <!-- DataView Content -->
        <div class="col-12 md:col-10">
          <div class="bg-white-alpha-10 backdrop-blur-md border-round-xl p-4 border-white-alpha-20">
            <p-dataView #dv [value]="searchResults()?.products" [layout]="selectedLayout()" [paginator]="true" [rows]="12" [totalRecords]="searchResults()?.totalResults || 0"
              [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos" class="w-full border-round-xl overflow-hidden">

              <ng-template #header>
                <div class="flex justify-content-between align-items-center">
                  <h3 class="font-semibold mb-0">Productos</h3>
                  <form [formGroup]="layoutForm">
                    <p-selectbutton [options]="layoutOptions" formControlName="selectedLayout" [allowEmpty]="false" optionValue="value" (onChange)="onLayoutChange($event.value)"
                      class="w-12rem">
                      <ng-template #item let-option>
                        <div class="flex align-items-center gap-2">
                          <i [class]="option.icon"></i>
                        </div>
                      </ng-template>
                    </p-selectbutton>
                  </form>
                </div>
              </ng-template>

              <!-- Grid Layout Template -->
              <ng-template #grid let-items>
                <div class="grid p-3">
                  @for (product of items; track product.asin) {
                    <div class="col-12 sm:col-6 lg:col-4 xl:col-3 p-2">
                      <p-card class="h-full border-round-xl overflow-hidden transition-all transition-duration-300 hover:shadow-6 cursor-pointer" (click)="openAmazonProduct(product.url)">
                        <ng-template #header>
                          <div class="relative overflow-hidden flex align-items-center justify-content-center product-image-bg" style="height: 14rem;">
                            <img [src]="getProductImage(product)" [alt]="product.title" style="max-width: 90%; max-height: 90%; object-fit: contain;"
                              (error)="onImageError($event)" />
                            @if (product.price.original) {
                              <div class="absolute top-0 right-0 m-2">
                                <p-tag [value]="'-' + getDiscountPercentage(product.price.original, product.price.current) + '%'" severity="success" class="text-base" />
                              </div>
                            }
                          </div>
                        </ng-template>

                        <ng-template #content>
                          <div class="flex flex-column" style="min-height: 14rem;">
                            <!-- Category -->
                            <div class="mb-2">
                              <p-tag [value]="product.category" icon="pi pi-tag" severity="info" />
                            </div>

                            <!-- Product Title -->
                            <h4 class="product-title text-base font-semibold m-0 line-height-3" style="color: var(--p-text-color)">
                              {{ product.title }}
                            </h4>

                            <!-- Price block pushed to bottom -->
                            <div class="flex flex-column gap-2 mt-auto">
                              <p-divider />
                              <!-- Current price -->
                              <div class="flex align-items-baseline gap-2">
                                <span class="text-2xl font-bold price-green">
                                  {{ getCurrencySymbol() }}{{ formatPrice(product.price.current) }}
                                </span>
                                <span class="text-xs" style="color: var(--p-text-muted-color)">{{ getCurrencyCode() }}</span>
                                @if (product.price.original) {
                                  <span class="text-sm line-through" style="color: var(--p-text-muted-color)">
                                    {{ getCurrencySymbol() }}{{ formatPrice(product.price.original) }}
                                  </span>
                                }
                              </div>

                              <!-- Shipping -->
                              <div class="flex align-items-center gap-2 text-sm">
                                <i class="pi pi-truck text-xs" [ngClass]="isFreeShipping(product) ? 'price-green' : ''" [style.color]="!isFreeShipping(product) ? 'var(--p-text-muted-color)' : null"></i>
                                @if (isFreeShipping(product)) {
                                  <span class="price-green font-medium">Envío GRATIS (pedidos {{ getFreeShippingThreshold() }} {{ getCurrencyCode() }})</span>
                                }
                                @if (!isFreeShipping(product)) {
                                  <span style="color: var(--p-text-muted-color)">Envío gratis en pedidos {{ getFreeShippingThreshold() }} {{ getCurrencyCode() }}</span>
                                }
                              </div>

                              <!-- Total (only when different from price) -->
                              @if (getShippingPrice(product) > 0) {
                                <div class="flex align-items-center justify-content-center gap-2 p-2 border-round total-price-bg">
                                  <span class="text-lg font-bold price-total">
                                    Total: {{ getCurrencySymbol() }}{{ formatPrice(getTotalPrice(product)) }} {{ getCurrencyCode() }}
                                  </span>
                                </div>
                              }

                              <!-- Button -->
                              <div class="flex justify-content-center">
                                <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn"
                                  (onClick)="openAmazonProduct(product.url); $event.stopPropagation()" />
                              </div>
                            </div>
                          </div>
                        </ng-template>
                      </p-card>
                    </div>
                  }
                </div>
              </ng-template>

              <!-- List Layout Template -->
              <ng-template #list let-items>
                <div class="flex flex-column gap-3 p-3">
                  @for (product of items; track product.asin) {
                    <p-card class="border-round-xl overflow-hidden transition-all transition-duration-300 hover:shadow-4 cursor-pointer" (click)="openAmazonProduct(product.url)">
                      <ng-template #content>
                        <div class="flex flex-column md:flex-row gap-4">
                          <!-- Product Image -->
                          <div class="flex-shrink-0 md:w-18rem">
                            <div class="relative overflow-hidden border-round flex align-items-center justify-content-center product-image-bg" style="height: 14rem;">
                              <img [src]="getProductImage(product)" [alt]="product.title" style="max-width: 90%; max-height: 90%; object-fit: contain;"
                                (error)="onImageError($event)" />
                              @if (product.price.original) {
                                <div class="absolute top-0 right-0 m-2">
                                  <p-tag [value]="'-' + getDiscountPercentage(product.price.original, product.price.current) + '%'" severity="success" class="text-base" />
                                </div>
                              }
                            </div>
                          </div>

                          <!-- Product Details -->
                          <div class="flex-1 flex flex-column gap-2">
                            <!-- Category -->
                            <div>
                              <p-tag [value]="product.category" icon="pi pi-tag" severity="info" />
                            </div>

                            <!-- Title -->
                            <h4 class="text-lg font-semibold m-0 line-height-3" style="color: var(--p-text-color)">
                              {{ product.title }}
                            </h4>

                            <p-divider />

                            <!-- Price and actions -->
                            <div class="flex flex-column md:flex-row justify-content-between align-items-start md:align-items-center gap-3 mt-auto">
                              <div class="flex align-items-center gap-3 flex-wrap">
                                <!-- Price -->
                                <div class="flex align-items-baseline gap-2">
                                  <span class="text-2xl font-bold price-green">
                                    {{ getCurrencySymbol() }}{{ formatPrice(product.price.current) }}
                                  </span>
                                  <span class="text-xs" style="color: var(--p-text-muted-color)">{{ getCurrencyCode() }}</span>
                                  @if (product.price.original) {
                                    <span class="text-sm line-through" style="color: var(--p-text-muted-color)">
                                      {{ getCurrencySymbol() }}{{ formatPrice(product.price.original) }}
                                    </span>
                                  }
                                </div>

                                <!-- Shipping -->
                                <div class="flex align-items-center gap-1 text-sm">
                                  <i class="pi pi-truck text-xs" [ngClass]="isFreeShipping(product) ? 'price-green' : ''" [style.color]="!isFreeShipping(product) ? 'var(--p-text-muted-color)' : null"></i>
                                  @if (isFreeShipping(product)) {
                                    <span class="price-green font-medium">Envío GRATIS</span>
                                  }
                                  @if (!isFreeShipping(product)) {
                                    <span style="color: var(--p-text-muted-color)">Envío gratis en {{ getFreeShippingThreshold() }}</span>
                                  }
                                </div>

                                <!-- Total (only when different from price) -->
                                @if (getShippingPrice(product) > 0) {
                                  <div class="flex align-items-center gap-2 p-2 border-round total-price-bg">
                                    <span class="font-bold price-total">
                                      Total: {{ getCurrencySymbol() }}{{ formatPrice(getTotalPrice(product)) }} {{ getCurrencyCode() }}
                                    </span>
                                  </div>
                                }
                              </div>

                              <!-- Button -->
                              <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn"
                                (onClick)="openAmazonProduct(product.url); $event.stopPropagation()" />
                            </div>
                          </div>
                        </div>
                      </ng-template>
                    </p-card>
                  }
                </div>
              </ng-template>
            </p-dataView>

            <!-- Price Disclaimer -->
            <div class="mt-3 p-3 border-round bg-white-alpha-10">
              <p class="text-xs text-blue-200 m-0">
                <i class="pi pi-info-circle mr-1"></i>
                Los precios y la disponibilidad de los productos son precisos a la fecha/hora indicada y estan sujetos a cambios.
                Cualquier información de precios mostrada en el momento de la compra se aplicará a la misma.
                Como Asociado de Amazon, obtengo ingresos por compras adscritas.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>
  }

  <!-- Empty State -->
  @if (!searchResults() && !isLoading() && !errorMessage()) {
    <div class="text-center py-8">
      <i class="pi pi-search text-6xl text-blue-200 mb-4"></i>
      <h3 class="text-lg md:text-xl font-semibold text-white mb-2">No hay productos para mostrar</h3>
      <p class="text-base md:text-lg font-normal text-blue-100">Realiza una búsqueda para encontrar productos increíbles</p>
    </div>
  }
</div>
