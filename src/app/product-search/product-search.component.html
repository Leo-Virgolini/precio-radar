<div>
  <!-- Loading State - Skeleton -->
  @if (isLoading()) {
  <div class="p-1 md:p-4">
    <div class="mb-2 md:mb-4">
      <p-skeleton width="40%" height="2rem" class="mb-2 md:mb-3" />
      <p-skeleton width="20%" height="1rem" class="mb-2 md:mb-4" />
    </div>
    <!-- Mobile skeleton: compact list rows -->
    <div class="flex flex-column gap-2 md:hidden">
      @for (item of skeletonItems; track $index) {
      <div class="surface-ground border-round-xl p-2 flex gap-3 align-items-center">
        <p-skeleton width="5rem" height="5rem" borderRadius="0.5rem" />
        <div class="flex-1">
          <p-skeleton width="90%" height="0.8rem" class="mb-2" />
          <p-skeleton width="70%" height="0.8rem" class="mb-2" />
          <p-skeleton width="40%" height="1.2rem" class="mb-1" />
          <p-skeleton width="50%" height="0.7rem" />
        </div>
      </div>
      }
    </div>
    <!-- Desktop skeleton: grid cards -->
    <div class="hidden md:block">
      <div class="grid">
        @for (item of skeletonItems; track $index) {
        <div class="col-12 sm:col-6 lg:col-4 xl:col-3 p-2">
          <div class="surface-ground border-round-xl p-3">
            <p-skeleton width="100%" height="14rem" class="mb-3" />
            <p-skeleton width="60%" height="1rem" class="mb-2" />
            <p-skeleton width="100%" height="1rem" class="mb-2" />
            <p-skeleton width="80%" height="1rem" class="mb-3" />
            <p-skeleton width="40%" height="1.5rem" class="mb-2" />
            <p-skeleton width="50%" height="1rem" />
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- Results -->
  @if (searchResults() && !isLoading()) {
  <div class="p-1 md:p-4">
    <!-- DataView Controls -->
    <form [formGroup]="filterForm">
      <div class="flex flex-column gap-3 mb-3">
        <!-- Title row -->
        <div class="flex flex-column md:flex-row align-items-start md:align-items-center gap-1 md:gap-3">
          <h2 class="text-lg md:text-2xl font-semibold text-color m-0">
            @if (searchQuery) {
            Resultados de "{{ searchQuery }}"
            } @else {
            Resultados de búsqueda
            }
          </h2>
          <span class="text-sm font-normal text-color-secondary">
            ({{ searchResults()?.totalResults || 0 }} productos)
          </span>
        </div>
        <!-- Sort + Filter row -->
        <div class="flex align-items-center gap-2 md:justify-content-end">
          <!-- Mobile/Tablet Filter Button -->
          <div class="block lg:hidden">
            <p-button label="Filtros" icon="pi pi-filter" severity="secondary" (onClick)="showFilterDrawer.set(true)" />
          </div>
          <div class="flex align-items-center gap-2 flex-1 md:flex-none">
            <label class="text-color font-medium text-sm md:text-base white-space-nowrap"><i class="pi pi-sort-alt mr-1"></i>Ordenar:</label>
            <p-select [options]="sortOptions" formControlName="selectedSort" optionLabel="label" (onChange)="onSortChange($event.value)" placeholder="Ordenar por"
              class="flex-1 md:w-19rem">
              <ng-template #selectedItem let-option>
                <div class="flex align-items-center gap-2">
                  <i [class]="option.icon"></i>
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
              <ng-template #item let-option>
                <div class="flex align-items-center gap-2">
                  <i [class]="option.icon"></i>
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>
        </div>
      </div>
    </form>

    <div class="grid">
      <!-- Filters Sidebar (desktop only) -->
      <div class="hidden lg:block lg:col-2">
        <form [formGroup]="filterForm" class="surface-card border-round-xl p-4 border-2 border-primary-100 shadow-2">
          <h4 class="text-color font-semibold mt-0"><i class="pi pi-filter mr-2"></i>Filtros</h4>

          <!-- Region Filter (only in ALL tab) -->
          @if (amazonRegion === 'ALL') {
          <div class="mb-4">
            <label class="text-color font-medium mb-2 block"><i class="pi pi-globe mr-1 text-sm"></i>Región</label>
            <p-select [options]="regionOptions" formControlName="regionFilter" optionLabel="label" optionValue="value" placeholder="Todas las regiones" (onChange)="applyFilters()"
              class="w-full">
              <ng-template #selectedItem let-option>
                <div class="flex align-items-center gap-2">
                  @if (option.flag) {
                  <img [src]="option.flag" width="16" height="12" [alt]="option.label" />
                  } @else {
                  <i [class]="option.icon"></i>
                  }
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
              <ng-template #item let-option>
                <div class="flex align-items-center gap-2">
                  @if (option.flag) {
                  <img [src]="option.flag" width="16" height="12" [alt]="option.label" />
                  } @else {
                  <i [class]="option.icon"></i>
                  }
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>
          }

          <!-- Price Range Filter -->
          <div class="mb-4">
            <label class="text-color font-medium mb-2 block"><i class="pi pi-dollar mr-1 text-sm"></i>Rango de Precios
              <span class="text-xs text-color-secondary font-normal">
                @if (amazonRegion === 'ALL') { (USD / EUR) }
                @else if (amazonRegion === 'ES') { (EUR) }
                @else { (USD) }
              </span>
            </label>
            <p-slider formControlName="priceRange" [min]="0" [max]="maxPriceLimit" [range]="true" (onChange)="applyFilters()" class="w-full mb-3">
            </p-slider>
            <div class="flex align-items-center gap-2">
              <p-inputNumber [ngModel]="filterForm.get('priceRange')?.value?.[0] || 0" (onInput)="onPriceInputChange(0, $event.value)" [min]="0" [max]="maxPriceLimit"
                [ngModelOptions]="{standalone: true}" placeholder="Min" size="small" inputStyleClass="w-full text-sm" class="flex-1" />
              <span class="text-color text-sm">-</span>
              <p-inputNumber [ngModel]="filterForm.get('priceRange')?.value?.[1] || maxPriceLimit" (onInput)="onPriceInputChange(1, $event.value)" [min]="0" [max]="maxPriceLimit"
                [ngModelOptions]="{standalone: true}" placeholder="Max" size="small" inputStyleClass="w-full text-sm" class="flex-1" />
            </div>
          </div>

          <!-- Category Filter -->
          <div class="mb-4">
            <label class="text-color font-medium mb-2 block"><i class="pi pi-th-large mr-1 text-sm"></i>Categoría</label>
            <p-select [options]="categories" formControlName="selectedCategory" optionLabel="label" optionValue="value" placeholder="Todas las categorías" (onChange)="applyFilters()"
              class="w-full">
              <ng-template #selectedItem let-option>
                @if (option?.label) {
                  <div class="flex align-items-center gap-2">
                    <i [class]="option.icon"></i>
                    <span>{{ option.label }}</span>
                  </div>
                }
              </ng-template>
              <ng-template #item let-option>
                <div class="flex align-items-center gap-2">
                  <i [class]="option.icon"></i>
                  <span>{{ option.label }}</span>
                </div>
              </ng-template>
            </p-select>
          </div>

          <!-- In Stock Filter -->
          <div class="mb-4">
            <div class="flex align-items-center justify-content-between">
              <label class="text-sm text-color"><i class="pi pi-check-circle mr-1 text-xs"></i>Con stock</label>
              <p-toggleswitch formControlName="inStockOnly" (onChange)="applyFilters()" />
            </div>
          </div>

          <!-- Free Shipping Filter -->
          <div class="mb-4">
            <div class="flex align-items-center justify-content-between">
              <label class="text-sm text-color"><i class="pi pi-truck mr-1 text-xs"></i>Envío gratis a Argentina</label>
              <p-toggleswitch formControlName="freeShippingOnly" (onChange)="applyFilters()" />
            </div>
          </div>

          <!-- Free Shipping $99+ Filter -->
          <div class="mb-4">
            <div class="flex align-items-center justify-content-between">
              <label class="text-sm text-color"><i class="pi pi-dollar mr-1 text-xs"></i>Envío gratis $99+</label>
              <p-toggleswitch formControlName="freeShippingThreshold" (onChange)="applyFilters()" />
            </div>
          </div>

          <!-- Discount Filter -->
          <div class="mb-4">
            <div class="flex align-items-center justify-content-between">
              <label class="text-sm text-color"><i class="pi pi-percentage mr-1 text-xs"></i>Solo con descuento</label>
              <p-toggleswitch formControlName="discountOnly" (onChange)="applyFilters()" />
            </div>
          </div>

          <!-- Rating Filter -->
          <div class="mb-4">
            <label class="text-color font-medium mb-2 block"><i class="pi pi-star-fill mr-1 text-sm"></i>Calificación mínima</label>
            <div class="flex align-items-center gap-2">
              <p-rating formControlName="minRating" [stars]="5" (onRate)="applyFilters()" class="filter-rating" />
              @if (filterForm.get('minRating')?.value > 0) {
              <i class="pi pi-times-circle text-sm cursor-pointer text-color-secondary hover:text-color" (click)="filterForm.patchValue({minRating: 0}); applyFilters()"></i>
              }
            </div>
          </div>

          <!-- Clear Filters -->
          <p-button label="Limpiar" icon="pi pi-filter-slash" severity="secondary" size="small" class="w-full" (onClick)="clearFilters()" />
        </form>
      </div>

      <!-- DataView Content -->
      <div class="col-12 lg:col-10">
          @if (!searchResults()?.products?.length) {
          <!-- Empty State -->
          <div class="flex flex-column align-items-center justify-content-center py-8 px-4 animate-fade-in">
            <i class="pi pi-search text-6xl mb-4 text-color-secondary"></i>
            <h3 class="text-xl font-semibold m-0 mb-2 text-color">No se encontraron productos</h3>
            <p class="text-sm m-0 mb-4 text-center text-color-secondary" style="max-width: 24rem;">
              No hay productos que coincidan con tu búsqueda. Probá con otros términos o limpiá los filtros.
            </p>
            <p-button label="Limpiar filtros" icon="pi pi-filter-slash" severity="secondary" (onClick)="clearFilters()" />
          </div>
          } @else {
          <div #dataViewAnchor style="scroll-margin-top: 8rem"></div>
          <p-dataView #dv [value]="searchResults()?.products" [layout]="effectiveLayout()" [paginator]="true" [rows]="12" [first]="dataViewFirst()" [totalRecords]="searchResults()?.totalResults || 0"
            [showCurrentPageReport]="true" currentPageReportTemplate="{first} - {last} de {totalRecords} productos" class="w-full border-round-xl overflow-hidden"
            (onPage)="onPageChange($event)">

            <ng-template #header>
              <div class="flex justify-content-between align-items-center">
                <h3 class="font-semibold mb-0"><i class="pi pi-shopping-bag mr-2"></i>Productos</h3>
                <form [formGroup]="layoutForm" class="hidden md:block">
                  <p-selectbutton [options]="layoutOptions" formControlName="selectedLayout" [allowEmpty]="false" optionValue="value" (onChange)="onLayoutChange($event.value)"
                    class="w-12rem">
                    <ng-template #item let-option>
                      <div class="flex align-items-center gap-2">
                        <i [class]="option.icon"></i>
                      </div>
                    </ng-template>
                  </p-selectbutton>
                </form>
              </div>
            </ng-template>

            <!-- Grid Layout Template -->
            <ng-template #grid let-items>
              <div class="grid p-3">
                @for (product of items; track product.asin) {
                <div class="col-12 sm:col-6 lg:col-4 xl:col-3 p-2 animate-card-enter" [style.animation-delay]="($index * 50) + 'ms'">
                  <p-card class="h-full border-round-xl overflow-hidden cursor-pointer" (click)="openProductDetail(product)">
                    <ng-template #header>
                      <div class="relative product-card-image">
                        <div class="product-detail-overlay">
                          <span><i class="pi pi-eye"></i>Ver detalles</span>
                        </div>
                        <div class="flex align-items-center justify-content-center product-image-bg grid-card-image">
                          <img [src]="resizeImageUrl(product.imageUrls?.[0] ?? '', 'card')" [alt]="product.title" class="grid-card-img" (error)="onImageError($event)" />
                        </div>
                        <div class="absolute top-0 left-0 m-2" style="z-index: 1;">
                          <p-button [icon]="isFavorite(product.asin) ? 'pi pi-heart-fill' : 'pi pi-heart'" [rounded]="true" [severity]="isFavorite(product.asin) ? 'danger' : 'secondary'"
                            size="small" [attr.aria-label]="isFavorite(product.asin) ? 'Quitar de favoritos' : 'Agregar a favoritos'"
                            (onClick)="toggleFavorite(product); $event.stopPropagation()" />
                        </div>
                        @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
                        <span class="discount-badge discount-badge-lg">
                          -{{ getDiscountPercentage(product.originalPrice, product.currentPrice ?? 0) }}%
                        </span>
                        }
                        @if (!product.inStock) {
                        <div class="out-of-stock-overlay">
                          <span class="out-of-stock-badge">Sin stock</span>
                        </div>
                        }
                      </div>
                    </ng-template>

                    <ng-template #content>
                      <div class="flex flex-column" class="grid-card-content">
                        <!-- Category and Region -->
                        <div class="mb-2 flex align-items-center gap-2 flex-wrap">
                          <p-tag [value]="product.category" icon="pi pi-tag" severity="info" />
                          @if (amazonRegion === 'ALL') {
                          <span class="inline-flex align-items-center gap-1 px-2 py-1 border-round text-xs font-semibold"
                            [class]="product.region === 'ES' ? 'bg-orange-100 text-orange-900' : 'bg-blue-100 text-blue-900'">
                            <img [src]="product.region === 'ES' ? 'https://flagcdn.com/16x12/es.png' : 'https://flagcdn.com/16x12/us.png'" width="16" height="12"
                              [alt]="product.region === 'ES' ? 'España' : 'USA'" />
                            {{ getRegionLabel(product) }}
                          </span>
                          }
                        </div>

                        <!-- Product Title -->
                        <h4 class="product-title text-base font-semibold m-0 line-height-3 text-body">
                          {{ product.title }}
                        </h4>

                        <!-- Rating -->
                        @if (product.rating > 0) {
                        <div class="flex align-items-center gap-2 mt-1">
                          <p-rating [ngModel]="product.rating" [readonly]="true" [stars]="5" />
                          <span class="text-xs font-semibold text-body">{{ product.rating }}</span>
                          <span class="text-xs text-muted">({{ product.ratingCount.toLocaleString() }})</span>
                        </div>
                        }

                        <!-- Features -->
                        @if (product.aboutItem.length) {
                        <ul class="text-sm m-0 mt-1 pl-3 line-height-3 text-muted list-none" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                          @for (feature of product.aboutItem; track feature) {
                          <li class="mb-1">{{ feature }}</li>
                          }
                        </ul>
                        }

                        <!-- Price block pushed to bottom -->
                        <div class="flex flex-column gap-2 mt-auto">
                          <p-divider />
                          <!-- Current price -->
                          <div class="flex align-items-baseline gap-2 flex-wrap">
                            <span class="text-2xl font-bold price-green">
                              {{ getCurrencySymbol(product) }}{{ formatPrice(product.currentPrice) }}
                            </span>
                            <span class="text-xs text-muted">{{ getCurrencyCode(product) }}</span>
                            @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
                            <span class="text-sm line-through text-muted">
                              {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice) }}
                            </span>
                            <span class="text-xs font-semibold savings-highlight">
                              <i class="pi pi-bolt text-xs mr-1"></i>Ahorrás {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice - (product.currentPrice ?? 0)) }}
                            </span>
                            }
                          </div>

                          <!-- Shipping -->
                          <div class="flex flex-column gap-1 text-sm">
                            @if (isDigitalProduct(product)) {
                            <div class="flex align-items-center gap-2">
                              <i class="pi pi-download text-xs price-green"></i>
                              <span class="price-green font-medium">Descarga digital</span>
                            </div>
                            } @else if (isFreeShipping(product)) {
                            <div class="flex align-items-center gap-2">
                              <i class="pi pi-truck text-xs price-green"></i>
                              <span class="price-green font-medium">Envío gratis a Argentina</span>
                            </div>
                            } @else {
                            <div class="flex align-items-center gap-2">
                              <i class="pi pi-truck text-xs shipping-info"></i>
                              <span class="shipping-info">Envío: {{ getCurrencySymbol(product) }}{{ formatPrice(getShippingPrice(product)) }}</span>
                            </div>
                            @if (product.freeShippingOver99) {
                            <div class="flex align-items-center gap-1">
                              <i class="pi pi-info-circle text-xs price-green"></i>
                              <span class="price-green text-xs">Envío gratis en pedidos $99+</span>
                            </div>
                            }
                            }
                          </div>

                          <!-- CTA Buttons -->
                          <div class="flex flex-column gap-2">
                            <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn" styleClass="w-full"
                              (onClick)="openAmazonProduct(product.url); $event.stopPropagation()" />
                            <p-button label="Agregar al carrito" icon="pi pi-shopping-cart" [outlined]="true" severity="warn" styleClass="w-full"
                              (onClick)="openAmazonProduct(product.addToCartUrl); $event.stopPropagation()" />
                          </div>
                        </div>
                      </div>
                    </ng-template>
                  </p-card>
                </div>
                }
              </div>
            </ng-template>

            <!-- List Layout Template -->
            <ng-template #list let-items>
              <div class="flex flex-column gap-3 p-1 md:p-3">
                @for (product of items; track product.asin) {
                <p-card class="border-round-xl overflow-hidden cursor-pointer animate-card-enter list-card" [style.animation-delay]="($index * 60) + 'ms'"
                  (click)="openProductDetail(product)">
                  <ng-template #content>
                    <div class="flex flex-row gap-3 md:gap-4">
                      <!-- Product Image - responsive size -->
                      <div class="flex-shrink-0 relative product-card-image list-card-image">
                        <div class="product-detail-overlay hidden md:flex">
                          <span><i class="pi pi-eye"></i>Ver detalles</span>
                        </div>
                        <div class="flex align-items-center justify-content-center product-image-bg border-round h-full">
                          <img [src]="resizeImageUrl(product.imageUrls?.[0] ?? '', 'card')" [alt]="product.title" class="grid-card-img" (error)="onImageError($event)" />
                        </div>
                        <div class="absolute top-0 left-0 m-1 md:m-2 hidden md:block" style="z-index: 1;">
                          <p-button [icon]="isFavorite(product.asin) ? 'pi pi-heart-fill' : 'pi pi-heart'" [rounded]="true" [severity]="isFavorite(product.asin) ? 'danger' : 'secondary'"
                            size="small" (onClick)="toggleFavorite(product); $event.stopPropagation()" />
                        </div>
                        @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
                        <span class="discount-badge">
                          -{{ getDiscountPercentage(product.originalPrice, product.currentPrice ?? 0) }}%
                        </span>
                        }
                        @if (!product.inStock) {
                        <div class="out-of-stock-overlay">
                          <span class="out-of-stock-badge">Sin stock</span>
                        </div>
                        }
                      </div>

                      <!-- Product Details -->
                      <div class="flex-1 flex flex-column gap-1 md:gap-2 min-w-0">
                        <!-- Category & Region - desktop only -->
                        <div class="hidden md:flex align-items-center gap-2 flex-wrap">
                          <p-tag [value]="product.category" icon="pi pi-tag" severity="info" />
                          @if (amazonRegion === 'ALL') {
                          <span class="inline-flex align-items-center gap-1 px-2 py-1 border-round text-xs font-semibold"
                            [class]="product.region === 'ES' ? 'bg-orange-100 text-orange-900' : 'bg-blue-100 text-blue-900'">
                            <img [src]="product.region === 'ES' ? 'https://flagcdn.com/16x12/es.png' : 'https://flagcdn.com/16x12/us.png'" width="16" height="12"
                              [alt]="product.region === 'ES' ? 'España' : 'USA'" />
                            {{ getRegionLabel(product) }}
                          </span>
                          }
                        </div>

                        <!-- Title -->
                        <h4 class="text-sm md:text-lg font-semibold m-0 line-height-3 text-body list-card-title">{{ product.title }}</h4>

                        <!-- Rating -->
                        @if (product.rating > 0) {
                        <div class="flex align-items-center gap-1 md:gap-2">
                          <p-rating [ngModel]="product.rating" [readonly]="true" [stars]="5" />
                          <span class="text-xs font-semibold text-body">{{ product.rating }}</span>
                          <span class="text-xs text-muted">({{ product.ratingCount.toLocaleString() }})</span>
                        </div>
                        }

                        <!-- Features - desktop only -->
                        @if (product.aboutItem.length) {
                        <ul class="hidden md:block text-sm m-0 pl-3 line-height-3 text-muted list-none">
                          @for (feature of product.aboutItem.slice(0, 2); track feature) {
                          <li class="mb-1">{{ feature }}</li>
                          }
                        </ul>
                        }

                        <p-divider class="hidden md:block" />

                        <!-- Price -->
                        <div class="flex align-items-baseline gap-2 flex-wrap">
                          <span class="text-lg md:text-2xl font-bold price-green">{{ getCurrencySymbol(product) }}{{ formatPrice(product.currentPrice) }}</span>
                          <span class="hidden md:inline text-xs text-muted">{{ getCurrencyCode(product) }}</span>
                          @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
                          <span class="text-xs md:text-sm line-through text-muted">{{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice) }}</span>
                          <span class="hidden md:inline-flex text-xs font-semibold savings-highlight">
                            <i class="pi pi-bolt text-xs mr-1"></i>Ahorrás {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice - (product.currentPrice ?? 0)) }}
                          </span>
                          }
                        </div>

                        <!-- Shipping + Favorite (mobile) -->
                        <div class="flex align-items-center gap-2">
                          @if (isDigitalProduct(product)) {
                          <span class="price-green text-xs md:text-sm font-medium"><i class="pi pi-download text-xs mr-1"></i>Descarga digital</span>
                          } @else if (isFreeShipping(product)) {
                          <span class="price-green text-xs md:text-sm font-medium"><i class="pi pi-truck text-xs mr-1"></i>Envío gratis</span>
                          } @else {
                          <span class="shipping-info text-xs md:text-sm"><i class="pi pi-truck text-xs mr-1"></i>Envío: {{ getCurrencySymbol(product) }}{{
                            formatPrice(getShippingPrice(product)) }}</span>
                          }
                          @if (product.freeShippingOver99 && getShippingPrice(product) !== 0) {
                          <span class="hidden md:inline-flex price-green text-xs"><i class="pi pi-info-circle text-xs mr-1"></i>Gratis en $99+</span>
                          }
                          <!-- Favorite button - mobile only -->
                          <p-button [icon]="isFavorite(product.asin) ? 'pi pi-heart-fill' : 'pi pi-heart'" [rounded]="true" [severity]="isFavorite(product.asin) ? 'danger' : 'secondary'"
                            size="small" [text]="true" (onClick)="toggleFavorite(product); $event.stopPropagation()" class="ml-auto md:hidden" />
                        </div>
                        <!-- Amazon buttons - mobile only -->
                        <div class="md:hidden flex gap-2">
                          <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn" size="small" class="flex-1"
                            (onClick)="openAmazonProduct(product.url); $event.stopPropagation()" />
                          <p-button icon="pi pi-shopping-cart" [outlined]="true" severity="warn" size="small"
                            pTooltip="Agregar al carrito" tooltipPosition="top"
                            (onClick)="openAmazonProduct(product.addToCartUrl); $event.stopPropagation()" />
                        </div>

                        <!-- Amazon buttons - desktop only -->
                        <div class="hidden md:flex mt-auto gap-2">
                          <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn" (onClick)="openAmazonProduct(product.url); $event.stopPropagation()" />
                          <p-button icon="pi pi-shopping-cart" [outlined]="true" severity="warn"
                            pTooltip="Agregar al carrito" tooltipPosition="top"
                            (onClick)="openAmazonProduct(product.addToCartUrl); $event.stopPropagation()" />
                        </div>
                      </div>
                    </div>
                  </ng-template>
                </p-card>
                }
              </div>
            </ng-template>

          </p-dataView>
          }

      </div>
    </div>

  </div>
  }

  <!-- Empty State -->
  @if (!searchResults() && !isLoading()) {
  <div class="text-center py-8 animate-fade-in">
    <i class="pi pi-search text-6xl text-color-secondary mb-4"></i>
    <h3 class="text-lg md:text-xl font-semibold text-color mb-2">No hay productos para mostrar</h3>
    <p class="text-base md:text-lg font-normal text-color-secondary">Realiza una búsqueda para encontrar productos increíbles</p>
  </div>
  }
</div>

<!-- Mobile Filter Drawer -->
<p-drawer [(visible)]="showFilterDrawer" [header]="'Filtros'" position="left" [style]="{ width: '18rem' }" appendTo="body">
  <form [formGroup]="filterForm">
    <!-- Region Filter (only in ALL tab) -->
    @if (amazonRegion === 'ALL') {
    <div class="mb-4">
      <label class="font-medium mb-2 block"><i class="pi pi-globe mr-1 text-sm"></i>Región</label>
      <p-select [options]="regionOptions" formControlName="regionFilter" optionLabel="label" optionValue="value" placeholder="Todas las regiones" (onChange)="applyFilters()"
        class="w-full">
        <ng-template #selectedItem let-option>
          <div class="flex align-items-center gap-2">
            @if (option.flag) {
            <img [src]="option.flag" width="16" height="12" [alt]="option.label" />
            } @else {
            <i [class]="option.icon"></i>
            }
            <span>{{ option.label }}</span>
          </div>
        </ng-template>
        <ng-template #item let-option>
          <div class="flex align-items-center gap-2">
            @if (option.flag) {
            <img [src]="option.flag" width="16" height="12" [alt]="option.label" />
            } @else {
            <i [class]="option.icon"></i>
            }
            <span>{{ option.label }}</span>
          </div>
        </ng-template>
      </p-select>
    </div>
    }

    <!-- Price Range Filter -->
    <div class="mb-4">
      <label class="font-medium mb-2 block"><i class="pi pi-dollar mr-1 text-sm"></i>Rango de Precios
        <span class="text-xs font-normal">
          @if (amazonRegion === 'ALL') { (USD / EUR) }
          @else if (amazonRegion === 'ES') { (EUR) }
          @else { (USD) }
        </span>
      </label>
      <p-slider formControlName="priceRange" [min]="0" [max]="maxPriceLimit" [range]="true" (onChange)="applyFilters()" class="w-full mb-3">
      </p-slider>
      <div class="flex align-items-center gap-2">
        <p-inputNumber [ngModel]="filterForm.get('priceRange')?.value?.[0] || 0" (onInput)="onPriceInputChange(0, $event.value)" [min]="0" [max]="maxPriceLimit"
          [ngModelOptions]="{standalone: true}" placeholder="Min" size="small" inputStyleClass="w-full text-sm" class="flex-1" />
        <span class="text-sm">-</span>
        <p-inputNumber [ngModel]="filterForm.get('priceRange')?.value?.[1] || maxPriceLimit" (onInput)="onPriceInputChange(1, $event.value)" [min]="0" [max]="maxPriceLimit"
          [ngModelOptions]="{standalone: true}" placeholder="Max" size="small" inputStyleClass="w-full text-sm" class="flex-1" />
      </div>
    </div>

    <!-- Category Filter -->
    <div class="mb-4">
      <label class="font-medium mb-2 block"><i class="pi pi-th-large mr-1 text-sm"></i>Categoría</label>
      <p-select [options]="categories" formControlName="selectedCategory" optionLabel="label" optionValue="value" placeholder="Todas las categorías" (onChange)="applyFilters()"
        class="w-full">
        <ng-template #selectedItem let-option>
          <div class="flex align-items-center gap-2">
            <i [class]="option.icon"></i>
            <span>{{ option.label }}</span>
          </div>
        </ng-template>
        <ng-template #item let-option>
          <div class="flex align-items-center gap-2">
            <i [class]="option.icon"></i>
            <span>{{ option.label }}</span>
          </div>
        </ng-template>
      </p-select>
    </div>

    <!-- In Stock Filter -->
    <div class="mb-4">
      <div class="flex align-items-center justify-content-between">
        <label class="text-sm"><i class="pi pi-check-circle mr-1 text-xs"></i>Con stock</label>
        <p-toggleswitch formControlName="inStockOnly" (onChange)="applyFilters()" />
      </div>
    </div>

    <!-- Free Shipping Filter -->
    <div class="mb-4">
      <div class="flex align-items-center justify-content-between">
        <label class="text-sm"><i class="pi pi-truck mr-1 text-xs"></i>Envío gratis a Argentina</label>
        <p-toggleswitch formControlName="freeShippingOnly" (onChange)="applyFilters()" />
      </div>
    </div>

    <!-- Free Shipping $99+ Filter -->
    <div class="mb-4">
      <div class="flex align-items-center justify-content-between">
        <label class="text-sm"><i class="pi pi-dollar mr-1 text-xs"></i>Envío gratis $99+</label>
        <p-toggleswitch formControlName="freeShippingThreshold" (onChange)="applyFilters()" />
      </div>
    </div>

    <!-- Discount Filter -->
    <div class="mb-4">
      <div class="flex align-items-center justify-content-between">
        <label class="text-sm"><i class="pi pi-percentage mr-1 text-xs"></i>Solo con descuento</label>
        <p-toggleswitch formControlName="discountOnly" (onChange)="applyFilters()" />
      </div>
    </div>

    <!-- Rating Filter -->
    <div class="mb-4">
      <label class="font-medium mb-2 block"><i class="pi pi-star-fill mr-1 text-sm"></i>Calificación mínima</label>
      <div class="flex align-items-center gap-2">
        <p-rating formControlName="minRating" [stars]="5" (onRate)="applyFilters()" class="filter-rating" />
        @if (filterForm.get('minRating')?.value > 0) {
        <i class="pi pi-times-circle text-sm cursor-pointer" (click)="filterForm.patchValue({minRating: 0}); applyFilters()"></i>
        }
      </div>
    </div>

    <!-- Clear Filters -->
    <p-button label="Limpiar filtros" icon="pi pi-filter-slash" severity="secondary" size="small" class="w-full" (onClick)="clearFilters(); showFilterDrawer.set(false)" />
  </form>
</p-drawer>

<!-- Product Detail Dialog -->
@if (selectedProduct(); as product) {
<p-dialog [visible]="showProductDialog()" (visibleChange)="onDialogVisibilityChange($event)" [modal]="true" [dismissableMask]="true" [draggable]="false" [style]="{ width: '90vw', 'max-width': '50rem' }" [breakpoints]="{ '768px': '95vw' }"
  appendTo="body">
  <ng-template #header>
    <div class="flex align-items-center gap-1 md:gap-2 flex-wrap">
      <p-button [icon]="isFavorite(product.asin) ? 'pi pi-heart-fill' : 'pi pi-heart'" [rounded]="true" [severity]="isFavorite(product.asin) ? 'danger' : 'secondary'" size="small"
        [attr.aria-label]="isFavorite(product.asin) ? 'Quitar de favoritos' : 'Agregar a favoritos'" (onClick)="toggleFavorite(product)" />
      <p-tag [value]="product.category" icon="pi pi-tag" severity="info" [style]="{ 'font-size': '0.7rem' }" />
      @if (amazonRegion === 'ALL') {
      <span class="inline-flex align-items-center gap-1 px-1 md:px-2 py-1 border-round font-semibold" style="font-size: 0.7rem;"
        [class]="product.region === 'ES' ? 'bg-orange-100 text-orange-900' : 'bg-blue-100 text-blue-900'">
        <img [src]="product.region === 'ES' ? 'https://flagcdn.com/16x12/es.png' : 'https://flagcdn.com/16x12/us.png'" width="14" height="10"
          [alt]="product.region === 'ES' ? 'España' : 'USA'" />
        {{ getRegionLabel(product) }}
      </span>
      }
      @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
      <span class="discount-badge discount-badge-sm">
        -{{ getDiscountPercentage(product.originalPrice, product.currentPrice ?? 0) }}%
      </span>
      }
    </div>
  </ng-template>

  <div class="flex flex-column md:flex-row gap-3 md:gap-4">
    <!-- Left column: Image + Price + Button -->
    <div class="flex-shrink-0 md:w-20rem flex flex-column gap-3">
      <p-galleria [value]="getProductImages(product, 'detail')" [numVisible]="4" [showThumbnails]="getProductImages(product).length > 1" [showIndicators]="false"
        [showItemNavigators]="getProductImages(product).length > 1" [showItemNavigatorsOnHover]="false" [responsiveOptions]="galleriaResponsiveOptions"
        [activeIndex]="activeImageIndex()" (activeIndexChange)="activeImageIndex.set($event)"
        [containerStyle]="{ 'max-width': '100%' }">
        <ng-template #item let-item>
          <div class="flex align-items-center justify-content-center product-image-bg border-round p-2 md:p-3" style="min-height: 10rem;">
            <p-image [src]="resizeImageUrl(item, 'full')" [alt]="product.title" imageClass="dialog-product-image" [preview]="true" (onImageError)="onImageError($event)" />
          </div>
        </ng-template>
        <ng-template #thumbnail let-item>
          <div class="flex align-items-center justify-content-center border-1 border-round surface-border surface-ground p-1" style="width: 3rem; height: 3rem;">
            <img [src]="resizeImageUrl(item, 'thumbnail')" [alt]="product.title" style="max-width: 100%; max-height: 100%; object-fit: contain;" (error)="onImageError($event)" />
          </div>
        </ng-template>
      </p-galleria>

      <!-- Buy Box -->
      <div class="buy-box surface-ground border-1 surface-border border-round-lg p-3 flex flex-column gap-2">
        <!-- Price -->
        <div class="flex align-items-baseline gap-2 flex-wrap">
          <span class="text-2xl font-bold price-green">
            {{ getCurrencySymbol(product) }}{{ formatPrice(product.currentPrice) }}
          </span>
          <span class="text-xs text-muted">{{ getCurrencyCode(product) }}</span>
        </div>
        @if (product.originalPrice && product.originalPrice > (product.currentPrice ?? 0)) {
        <div class="flex align-items-center gap-2 flex-wrap">
          <span class="text-sm line-through text-muted">
            {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice) }}
          </span>
          <span class="text-xs font-semibold savings-highlight">
            <i class="pi pi-bolt text-xs mr-1"></i>Ahorrás {{ getCurrencySymbol(product) }}{{ formatPrice(product.originalPrice - (product.currentPrice ?? 0)) }}
          </span>
        </div>
        }

        <p-divider class="my-0" />

        <!-- Shipping -->
        @if (isDigitalProduct(product)) {
        <div class="flex align-items-center gap-2">
          <i class="pi pi-download price-green text-sm"></i>
          <span class="price-green font-medium text-sm">Descarga digital</span>
        </div>
        } @else if (isFreeShipping(product)) {
        <div class="flex align-items-center gap-2">
          <i class="pi pi-truck price-green text-sm"></i>
          <span class="price-green font-medium text-sm">Envío gratis a Argentina</span>
        </div>
        } @else {
        <div class="flex align-items-center gap-2">
          <i class="pi pi-truck shipping-info text-sm"></i>
          <span class="shipping-info text-sm">
            Envío: {{ getCurrencySymbol(product) }}{{ formatPrice(getShippingPrice(product)) }} {{ getCurrencyCode(product) }}
          </span>
        </div>
        @if (product.freeShippingOver99) {
        <div class="flex align-items-center gap-1">
          <i class="pi pi-info-circle text-xs price-green"></i>
          <span class="price-green text-xs">Envío gratis en pedidos $99+</span>
        </div>
        }
        }

        <!-- Import Charges -->
        @if ((product.importCharges ?? 0) > 0) {
        <div class="flex align-items-center gap-2">
          <i class="pi pi-globe shipping-info text-sm"></i>
          <span class="shipping-info text-sm">
            Importación: {{ getCurrencySymbol(product) }}{{ formatPrice(product.importCharges) }} {{ getCurrencyCode(product) }}
          </span>
        </div>
        }

        <p-divider class="my-0" />

        <!-- Availability + Destination -->
        <div class="flex align-items-center gap-2">
          <i [class]="'pi text-sm ' + (product.inStock ? 'pi-check-circle price-green' : 'pi-times-circle text-red-500')"></i>
          <span [class]="'text-sm ' + (product.inStock ? 'text-body' : 'text-red-500 font-semibold')">{{ product.inStock ? 'En stock' : 'Sin stock' }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <i class="pi pi-map-marker text-muted text-sm"></i>
          <span class="text-sm text-muted">Envío a: Argentina</span>
        </div>

        <!-- CTA Buttons -->
        <p-button label="Ver en Amazon" icon="pi pi-external-link" severity="warn" styleClass="w-full" (onClick)="openAmazonProduct(product.url)" />
        <p-button label="Agregar al carrito" icon="pi pi-shopping-cart" [outlined]="true" severity="warn" styleClass="w-full" (onClick)="openAmazonProduct(product.addToCartUrl)" />
        <p class="text-xs m-0 text-muted text-center">
          <i class="pi pi-info-circle mr-1"></i>Precios sujetos a cambios.
        </p>
      </div>
    </div>

    <!-- Right column: Title + Rating + Features -->
    <div class="flex-1 flex flex-column gap-2 md:gap-3">
      <!-- Title -->
      <h3 class="text-sm md:text-base font-bold m-0 line-height-3 text-body">
        {{ product.title }}
      </h3>

      <!-- Rating -->
      @if (product.rating > 0) {
      <div class="flex align-items-center gap-2">
        <p-rating [ngModel]="product.rating" [readonly]="true" [stars]="5" />
        <span class="text-xs md:text-sm font-semibold text-body">{{ product.rating }}</span>
        <span class="text-xs md:text-sm text-muted">({{ product.ratingCount.toLocaleString() }} reseñas)</span>
      </div>
      }

      <!-- Features -->
      @if (product.aboutItem.length) {
      <div #dialogFeatures class="overflow-hidden" [style.max-height]="showAllFeatures() ? 'none' : '24rem'">
        <ul class="text-xs md:text-sm m-0 pl-0 line-height-3 text-muted list-none">
          @for (feature of product.aboutItem; track feature) {
          <li class="mb-2 flex align-items-start gap-2">
            <i class="pi pi-check-circle text-xs mt-1 price-green"></i>
            <span>{{ feature }}</span>
          </li>
          }
        </ul>
      </div>
        @if (featuresOverflow() || showAllFeatures()) {
        <a class="text-xs cursor-pointer text-primary font-medium" (click)="showAllFeatures.set(!showAllFeatures())">
          <i class="pi" [class]="showAllFeatures() ? 'pi-chevron-up' : 'pi-chevron-down'" style="font-size: 0.65rem;"></i>
          {{ showAllFeatures() ? 'Ver menos' : 'Ver más' }}
        </a>
        }
      }
    </div>
  </div>

</p-dialog>
}